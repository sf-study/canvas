<!DOCTYPE html>
<html>
   <head>
     <title>Animating with sprite sheets</title>

      <style> 
         body {
            background: #dddddd;
         }

         #canvas {
            position: absolute;
            left: 0px;
            top: 20px;
            margin: 20px;
            background: #ffffff;
            border: thin inset rgba(100,150,230,0.5);
         }

         #animateButton {
            margin-top: 10px;
            margin-left: 15px;
            margin-bottom: 10px;
         }
      </style>
   </head>

  <body>
    <input id='Button' type='button' value='start'/>

    <canvas id='canvas' width='600' height='800'>
      Canvas not supported
    </canvas>

    <script src='../shared/js/requestNextAnimationFrame.js'></script>
    <script src='../shared/js/sprites.js'></script>
    <script>
      var canvas = document.getElementById('canvas'),
      context = canvas.getContext('2d'),
      btn=document.getElementById('Button'),
      
      BOMB_LEFT=100,
      BOMB_TOP=80,
      BOMB_WIDTH=180,
      BOMB_HEIGHT=130,

      NUM_EXPLOSION_PAINTERS=9,
      NUM_FUSE_PAINTERS=9,

      bombPainter=new ImagePainter('../shared/img/bomb.png'),
      bombNoFusePainter=new ImagePainter('bomb-no-fuse.png'),
      fuseBurningPainters=[],
      explosionPainters=[];

      // 两个精灵动画制作器：fuseBurningAnimator，explosionAnimator
      // 起初都有一个用于存放绘制器对象的空数组
      // 稍后应用程序会分别用适当的图像绘制器对象来初始化这两个数组
      fuseBurningAnimator=new SpriteAnimator(fuseBurningPainters,function(){
        bomb.painter=bombNoFusePainter;
      });

      explosionAnimator=new SpriteAnimator(explosionPainters,function(){
        bomb.painter=bombNoFusePainter;
      });
      bomb=new Sprite('bomb',bombPainter);
      
      function resetBombNoFuse(){
        bomb.painter=bombNoFusePainter;
      }

      btn.onclick=function(e){
        // 如果已经在播放动画，直接返回
        if(bomb.animating){
          return;
        }

        // 启动fuseBurningAnimator，播放时为两秒的动画
        // 当动画完成后，fuseBurningAnimator对象的回调函数会将炸弹精灵的绘制器对象设置为bombNoFusePainter
        // bombNoFusePainter对象会把另外一张图片绘制出来

        fuseBurningAnimator.start(bomb,2000);

        setTimeout(function(){
            // 动画延期两秒，播放完毕，explosionAnimator对象也会把炸弹精灵的绘制器对象设置为bombNoFusePainter
            explosionAnimator.start(bomb,1000);

            // 在炸弹爆炸完一秒后，应用程序将炸弹精灵的绘制器对象设置为bombPainter
            setTimeout(function(){
              bomb.painter=bombPainter;
            },2000);
        },3000);
      }

      function animate(now){
        context.clearRect(0,0,canvas.width,canvas.height);
        bomb.paint(context);
        window.requestNextAnimationFrame(animate);
      }

      bomb.left=BOMB_LEFT;
      bomb.top=BOMB_TOP;

      bomb.width=BOMB_WIDTH;
      bomb.height=BOMB_HEIGHT;

      for(var i=0;i<NUM_FUSE_PAINTERS;i++){
        fuseBurningPainters.push(
          new ImagePainter('fuse-0'+i+'.png'));
      }

      for (var i=0;i<NUM_EXPLOSION_PAINTERS;i++){
        explosionPainters.push(new ImagePainter('explosion-0'+i+'.png'));
      }

      window.requestNextAnimationFrame(animate);
      
    </script>
  </body>
</html>
